<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced HTTP Response Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { border-left: 4px solid #10b981; }
        .info { border-left: 4px solid #3b82f6; }
        .warning { border-left: 4px solid #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1d4ed8; }
        .output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üöÄ Enhanced HTTP Response System Test</h1>
    
    <div class="test-panel info">
        <h2>üìã System Status</h2>
        <p>This page verifies that the enhanced HTTP response system is working correctly.</p>
        <button onclick="checkSystem()">Check System Status</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>

    <div class="test-panel">
        <h2>üîß Test Functions</h2>
        <button onclick="testContainerExists()">1. Test Container Exists</button>
        <button onclick="testEnhancedSystem()">2. Test Enhanced System</button>
        <button onclick="testRealExecution()">3. Test Real Execution Hook</button>
        <button onclick="simulateExecution()">4. Simulate Tool Execution</button>
    </div>

    <div class="test-panel">
        <h2>üìä Test Output</h2>
        <div id="output" class="output">Click a test button to see output...</div>
    </div>

    <div class="test-panel success">
        <h2>‚úÖ What Should Happen</h2>
        <ul>
            <li><strong>Enhanced System Active:</strong> No more test data showing by default</li>
            <li><strong>Real Execution Capture:</strong> HTTP responses from actual tool executions</li>
            <li><strong>Professional UI:</strong> Better styling and detailed information</li>
            <li><strong>Copy Functions:</strong> Copy raw response and cURL commands</li>
            <li><strong>Execution Details:</strong> Tool name, timestamps, request/response data</li>
        </ul>
    </div>

    <script>
        let output = document.getElementById('output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.textContent = '';
        }

        function checkSystem() {
            log('üîç Checking Enhanced HTTP Response System...');
            
            // Check if enhanced system is loaded
            if (window.httpManager) {
                log('‚úÖ Enhanced HTTP Response Manager found', 'success');
                log(`Manager enabled: ${window.httpManager.isEnabled}`);
                log(`Current response: ${!!window.httpManager.currentResponse}`);
                log(`History entries: ${window.httpManager.responseHistory.length}`);
            } else {
                log('‚ùå Enhanced HTTP Response Manager not found', 'error');
            }

            // Check if app exists
            if (window.app) {
                log('‚úÖ ZK-PRET app found', 'success');
                log(`HTTP enabled: ${window.app.httpResponseEnabled}`);
            } else {
                log('‚ùå ZK-PRET app not found', 'error');
            }

            // Check container
            const container = document.getElementById('http-resp-container');
            if (container) {
                log('‚úÖ HTTP response container found', 'success');
                log(`Container display: ${container.style.display}`);
                log(`Container classes: ${container.className}`);
            } else {
                log('‚ùå HTTP response container not found', 'error');
            }
        }

        function testContainerExists() {
            log('üß™ Testing container existence...');
            
            const container = document.getElementById('http-resp-container');
            if (container) {
                log('‚úÖ Container found', 'success');
                
                // Check if it's hidden (should be hidden until real execution)
                if (container.style.display === 'none' || !container.style.display) {
                    log('‚úÖ Container properly hidden (waiting for real execution)', 'success');
                } else {
                    log('‚ö†Ô∏è Container is visible (may contain test data)', 'warning');
                }
                
                // Check summary fields
                const statusEl = document.getElementById('http-resp-status');
                if (statusEl && statusEl.textContent === '-') {
                    log('‚úÖ Summary fields cleared (no test data)', 'success');
                } else if (statusEl) {
                    log(`‚ö†Ô∏è Summary contains data: ${statusEl.textContent}`, 'warning');
                }
                
            } else {
                log('‚ùå Container not found', 'error');
            }
        }

        function testEnhancedSystem() {
            log('üß™ Testing enhanced system components...');
            
            if (window.httpManager) {
                const manager = window.httpManager;
                
                // Test methods exist
                const methods = ['captureHttpExecution', 'displayHttpResponse', 'updateSummary', 'toggleDetails', 'copyRawResponse'];
                methods.forEach(method => {
                    if (typeof manager[method] === 'function') {
                        log(`‚úÖ Method ${method} exists`, 'success');
                    } else {
                        log(`‚ùå Method ${method} missing`, 'error');
                    }
                });
                
                // Test properties
                log(`Manager state: enabled=${manager.isEnabled}, history=${manager.responseHistory.length}`);
                
            } else {
                log('‚ùå Enhanced system not loaded', 'error');
            }
        }

        function testRealExecution() {
            log('üß™ Testing real execution hook...');
            
            if (window.app && window.app.executeSync) {
                log('‚úÖ executeSync method found', 'success');
                
                // Check if method was patched
                const methodStr = window.app.executeSync.toString();
                if (methodStr.includes('Real execution started') || methodStr.includes('captureHttpExecution')) {
                    log('‚úÖ executeSync appears to be patched for HTTP capture', 'success');
                } else {
                    log('‚ö†Ô∏è executeSync may not be patched', 'warning');
                }
                
            } else {
                log('‚ùå executeSync method not found', 'error');
            }
        }

        function simulateExecution() {
            log('üß™ Simulating tool execution...');
            
            if (window.httpManager) {
                log('Creating mock execution data...');
                
                // Create realistic mock data based on actual GLEIF execution
                const mockResponseData = {
                    request: {
                        method: 'POST',
                        url: '/api/v1/tools/execute',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            toolName: 'get-GLEIF-verification-with-sign',
                            parameters: {
                                companyName: 'SREE PALANI ANDAVAR AGROS PRIVATE LIMITED',
                                typeOfNet: 'TESTNET'
                            }
                        }, null, 2),
                        timestamp: new Date().toISOString(),
                        toolName: 'get-GLEIF-verification-with-sign'
                    },
                    response: {
                        status: 200,
                        statusText: 'OK',
                        headers: { 'content-type': 'application/json' },
                        body: JSON.stringify({
                            success: true,
                            message: 'GLEIF verification completed successfully',
                            data: { lei: '894500Q32QG6KKGMMI95', status: 'COMPLIANT' }
                        }),
                        size: 21894,
                        time: 649223,
                        timestamp: new Date().toISOString(),
                        contentType: 'application/json'
                    },
                    result: { success: true },
                    success: true,
                    toolName: 'get-GLEIF-verification-with-sign',
                    executionId: 'test_' + Date.now()
                };
                
                log('üì° Displaying mock execution response...');
                window.httpManager.displayHttpResponse(mockResponseData);
                
                log('‚úÖ Mock execution completed - check sidebar for HTTP Response Details', 'success');
                
            } else {
                log('‚ùå Cannot simulate - enhanced system not available', 'error');
            }
        }

        // Auto-check on load
        setTimeout(checkSystem, 1000);

        log('üß™ Enhanced HTTP Response Test Panel ready');
        log('Click "Check System Status" to verify everything is working');
    </script>
</body>
</html>